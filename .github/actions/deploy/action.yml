name: Deploy to Kubernetes
description: "Deploy the application to the specified Kubernetes environment"
branding:
  icon: "play-circle"
  color: "green"
inputs:
  namespace-base:
    description: "The base name for the Kubernetes namespace (the environment name - alpha, beta, prod - will be appended to this)"
    required: false
    default: "smarter-ubc"
  anthropic-api-key:
    description: "The Anthropic API key"
    required: true
  authentication-backends:
    description: "The authentication backends to enable"
    required: false
  cohere-api-key:
    description: "The Cohere API key"
    required: false
  aws-access-key-id:
    description: "The AWS access key ID"
    required: true
  aws-secret-access-key:
    description: "The AWS secret access key"
    required: true
  aws-region:
    description: "The AWS region to deploy to"
    required: true
  dockerhub-username:
    description: "The DockerHub username"
    required: true
  dockerhub-pat:
    description: "The DockerHub personal access token"
    required: false
  environment:
    description: "The environment to deploy"
    required: true
  eks-cluster-name:
    description: "The name of the EKS cluster to deploy to"
    required: true
  fernet-encryption-key:
    description: "The Fernet encryption key"
    required: true
  fireworks-api-key:
    description: "The Fireworks API key"
    required: false
  gemini-api-key:
    description: "The Gemini API key"
    required: true
  google-service-account-b64:
    description: "The Google service account in base64 encoding"
    required: true
  google-maps-api-key:
    description: "The Google Maps API key"
    required: true
  llama-api-key:
    description: "The MetaAI Llama API key"
    required: true
  mailchimp-api-key:
    description: "The Mailchimp API key"
    required: true
  mailchimp-list-id:
    description: "The Mailchimp list ID"
    required: true
  mistral-api-key:
    description: "The Mistral API key"
    required: false
  openai-api-key:
    description: "The OpenAI API key"
    required: true
  platform-subdomain:
    description: "The platform subdomain to use in constructing URLs and email addresses"
    required: true
  pinecone-api-key:
    description: "The Pinecone API key"
    required: true
  pinecone-environment:
    description: "The Pinecone environment"
    required: true
  root-domain:
    description: "The root domain for the deployment"
    required: true
  smarter-logo:
    description: "The URL to the Smarter logo image"
    required: true
  smarter-mysql-test_database_password:
    description: "The MySQL test database password"
    required: true
  social-auth-google-oauth2-key:
    description: "The Google OAuth2 key"
    required: true
  social-auth-google-oauth2-secret:
    description: "The Google OAuth2 secret"
    required: true
  social-auth-github-key:
    description: "The GitHub OAuth2 key"
    required: true
  social-auth-github-secret:
    description: "The GitHub OAuth2 secret"
    required: true
  social-auth-linkedin-oauth2-key:
    description: "The LinkedIn OAuth2 key"
    required: true
  social-auth-linkedin-oauth2-secret:
    description: "The LinkedIn OAuth2 secret"
    required: true
  togetherai-api-key:
    description: "The TogetherAI API key"
    required: false

runs:
  using:
    "composite"
    # -------------------------------------------------------------------------
    # This action is designed to be run on an ephemeral Ubuntu Linux runner.
    # We start with a clean environment and install and configure all the
    # tools we need for this job.
    #
    # The runner is destroyed after the job completes, so we don't need to
    # worry about cleaning up after ourselves.
    # -------------------------------------------------------------------------
  steps:
    - name: Cache Helm dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.cache/helm
          helm/charts/smarter/charts
        key: helm-${{ runner.os }}-${{ hashFiles('helm/charts/smarter/Chart.yaml') }}-${{ hashFiles('helm/charts/smarter/requirements.yaml') }}
        restore-keys: |
          helm-${{ runner.os }}-

    # Initialize environment variables that are derived from the inputs
    # mcdaniel: we're not accomplishing anything by doing this bc this matches the default in aws_base.py
    - name: Initialize environment variables
      shell: bash
      run: |-
        echo "NAMESPACE=${{ inputs.namespace-base }}-${{ inputs.environment }}" >> $GITHUB_ENV
        echo "DJANGO_SETTINGS_MODULE=${{ env.DJANGO_SETTINGS_BASE }}.${{ inputs.environment }}" >> $GITHUB_ENV
        echo "CACHES_LOCATION=${{ env.REDIS_URL }}" >> $GITHUB_ENV
        echo "CELERY_BROKER_URL=${{ env.REDIS_URL }}" >> $GITHUB_ENV
        echo "CELERY_RESULT_BACKEND=${{ env.REDIS_URL }}" >> $GITHUB_ENV
      env:
        REDIS_URL: redis://:smarter@smarter-redis-master.${{ inputs.namespace-base }}-${{ inputs.environment }}.svc.cluster.local:6379/1
        DJANGO_SETTINGS_BASE: smarter.settings

    # Checkout all code referenced by this action
    - name: Checkout code
      id: checkout_code
      uses: actions/checkout@v5

    # authenticate AWS CLI
    - name: Configure AWS credentials
      id: aws-credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ inputs.aws-access-key-id }}
        aws-secret-access-key: ${{ inputs.aws-secret-access-key }}
        aws-region: ${{ inputs.aws-region }}

    # put an entry in the run log to show the aws cli version and the IAM user
    - name: Check awscli version and identity
      id: awscli-version
      shell: bash
      run: |-
        echo "aws cli version:"
        echo "----------------"
        aws --version
        echo
        echo "aws IAM user:"
        echo "-------------"
        aws sts get-caller-identity

    # install jq, which k8s-get-secret will use to parse the Kubernetes secret
    # and set the environment variables
    - name: Install jq and kubectl
      shell: bash
      run: |
        sudo apt-get update
        sudo apt-get install -y jq kubectl

    # setup kubeconfig using the aws eks helper command, 'update-kubeconfig'
    - name: Configure kubectl
      id: kubectl-configure
      shell: bash
      run: |-
        aws eks --region ${{ inputs.aws-region }} update-kubeconfig --name ${{ inputs.eks-cluster-name }} --alias ${{ inputs.eks-cluster-name }}
        echo "kubectl version and diagnostic info:"
        echo "------------------------------------"
        kubectl version

    # figure out the Docker image to add to the Helm values for the
    # Kubernetes deployment manifest.
    - name: Login to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v2

    # set the Docker image to the environment variable SMARTER_DOCKER_IMAGE
    # example:  012345678903.dkr.ecr.us-east-2.amazonaws.com/smarter-platform-alpha:latest
    # echo "SMARTER_DOCKER_IMAGE=${{ steps.login-ecr.outputs.registry }}/${{ env.AWS_ECR_REPO }}:latest" >> $GITHUB_ENV
    - name: Set Docker image
      id: set-docker-image
      shell: bash
      run: |-
        echo "SMARTER_DOCKER_IMAGE=mcdaniel0073/smarter:v0.13.143" >> $GITHUB_ENV
      env:
        AWS_ECR_REPO: ${{ env.NAMESPACE }}

    # extract the mysql configuration from the Kubernetes secret.
    # these will be set as environment variables for the Helm deployment
    #
    # example:
    # MYSQL_HOST: mysql.service.lawrencemcdaniel.com
    # MYSQL_PORT: 3306
    # MYSQL_DATABASE: smarter_api_dev
    # MYSQL_USER: smarter_api_dev
    # MYSQL_PASSWORD: top-secret-password
    - name: Configure MySQL from Kubernetes secret
      id: get-mysql-secret
      uses: ./.github/actions/k8s-get-secret
      with:
        eks-namespace: ${{ env.NAMESPACE }}
        eks-secret-name: mysql-smarter

    # extract the mysql root configuration from the Kubernetes secret.
    # these will be set as environment variables for the Helm deployment
    #
    # example:
    # MYMYSQL_ROOT_USERNAMESQL_USER: root
    # MYSQL_ROOT_PASSWORD: top-secret-password
    - name: Configure MySQL from Kubernetes secret
      id: get-mysql-root-secret
      uses: ./.github/actions/k8s-get-secret
      with:
        eks-namespace: ${{ env.NAMESPACE }}
        eks-secret-name: mysql-root

    # extract the Django admin user credentials from the Kubernetes secret.
    # these will be set as environment variables for the Helm deployment
    #
    # example:
    # SMARTER_LOGIN_URL: https://alpha.platform.smarter.sh/login/
    # SMARTER_ADMIN_USERNAME: admin
    # SMARTER_ADMIN_PASSWORD: top-secret-password
    - name: Configure admin user from Kubernetes secret
      id: get-admin-secret
      uses: ./.github/actions/k8s-get-secret
      with:
        eks-namespace: ${{ env.NAMESPACE }}
        eks-secret-name: smarter-admin

    # extract the Django SMTP email from the Kubernetes secret.
    # these will be set as environment variables for the Helm deployment
    #
    # example:
    # SMTP_HOST: email-smtp.us-east-2.amazonaws.com
    # SMTP_PORT: "587"
    # SMTP_USE_SSL: "false"
    # SMTP_USE_TLS: "true"
    # SMTP_USERNAME: an IAM key-pair id
    # SMTP_PASSWORD: an IAM key-pair secret
    - name: Configure SMTP email credentials from Kubernetes secret
      id: get-aws-ses-secret
      uses: ./.github/actions/k8s-get-secret
      with:
        eks-namespace: ${{ env.NAMESPACE }}
        eks-secret-name: aws-ses-config

    # extract the Django application secret from the Kubernetes secret.
    # these will be set as environment variables for the Helm deployment
    #
    # example:
    # SECRET_KEY: top-secret-key
    - name: Configure django secret from Kubernetes secret
      id: get-django-secret
      uses: ./.github/actions/k8s-get-secret
      with:
        eks-namespace: ${{ env.NAMESPACE }}
        eks-secret-name: smarter-django-secret-key

    # set env variable for branding info
    # TODO: map this to --- something???? --- could be Kubernetes secret, or
    # GitHub secret, or Helm values file...? TBD.
    - name: Set branding environment variables
      id: set-branding-env
      shell: bash
      run: |-
        echo "SMARTER_BRANDING_ADDRESS=851 Burlway Road, Suite 101, Burlingame, CA 94010" >> $GITHUB_ENV
        echo "SMARTER_BRANDING_CONTACT_URL=https://lawrencemcdaniel.com/contact/" >> $GITHUB_ENV
        echo "SMARTER_BRANDING_CORPORATE_NAME=Lawrence P. McDaniel, The Smarter Project" >> $GITHUB_ENV
        echo "SMARTER_BRANDING_SUPPORT_EMAIL=support@example.com" >> $GITHUB_ENV
        echo "SMARTER_BRANDING_SUPPORT_HOURS=MON-FRI 9:00 AM - 5:00 PM GMT-6 (CST)" >> $GITHUB_ENV
        echo "SMARTER_BRANDING_SUPPORT_PHONE_NUMBER=+1 (617) 555-6172" >> $GITHUB_ENV
        echo "SMARTER_EMAIL_ADMIN=lpm0073@gmail.com" >> $GITHUB_ENV

    # Dump all of our environment variables to the run log
    - name: Dump environment variables
      id: dump-env
      shell: bash
      run: |-
        echo "env"
        echo "-------------------------------"
        env

    - name: Delete failed jobs
      id: delete-failed-jobs
      shell: bash
      run: |-
        kubectl delete job smarter-db-init-job --namespace ${{ env.NAMESPACE }} || true

    - name: Create secrets values file
      id: create-json
      shell: bash
      run: |
        cat > /tmp/values.json <<EOF
        {
          "deployTimestamp": "$(date +%s)",
          "env": {
            "AUTHENTICATION_BACKENDS": ${{ inputs.authentication-backends && format('"{0}"', inputs.authentication-backends) || 'null' }},
            "AWS_ACCESS_KEY_ID": ${{ inputs.aws-access-key-id && format('"{0}"', inputs.aws-access-key-id) || 'null' }},
            "AWS_REGION": ${{ inputs.aws-region && format('"{0}"', inputs.aws-region) || 'null' }},
            "AWS_SECRET_ACCESS_KEY": ${{ inputs.aws-secret-access-key && format('"{0}"', inputs.aws-secret-access-key) || 'null' }},
            "CACHES_LOCATION": ${{ env.CACHES_LOCATION && format('"{0}"', env.CACHES_LOCATION) || 'null' }},
            "CELERY_BROKER_URL": ${{ env.CELERY_BROKER_URL && format('"{0}"', env.CELERY_BROKER_URL) || 'null' }},
            "CELERY_RESULT_BACKEND": ${{ env.CELERY_RESULT_BACKEND && format('"{0}"', env.CELERY_RESULT_BACKEND) || 'null' }},
            "DJANGO_SETTINGS_MODULE": ${{ env.DJANGO_SETTINGS_MODULE && format('"{0}"', env.DJANGO_SETTINGS_MODULE) || 'null' }},
            "DOCKERHUB_PAT": ${{ inputs.dockerhub-pat && format('"{0}"', inputs.dockerhub-pat) || 'null' }},
            "DOCKERHUB_USERNAME": ${{ inputs.dockerhub-username && format('"{0}"', inputs.dockerhub-username) || 'null' }},
            "ENVIRONMENT": ${{ inputs.environment && format('"{0}"', inputs.environment) || 'null' }},
            "NAMESPACE": ${{ env.NAMESPACE && format('"{0}"', env.NAMESPACE) || 'null' }},
            "SECRET_KEY": ${{ env.SECRET_KEY && format('"{0}"', env.SECRET_KEY) || 'null' }},
            "SMARTER_ADMIN_EMAIL": ${{ env.SMARTER_ADMIN_EMAIL && format('"{0}"', env.SMARTER_ADMIN_EMAIL) || 'null' }},
            "SMARTER_ADMIN_PASSWORD": ${{ env.SMARTER_ADMIN_PASSWORD && format('"{0}"', env.SMARTER_ADMIN_PASSWORD) || 'null' }},
            "SMARTER_ADMIN_USERNAME": ${{ env.SMARTER_ADMIN_USERNAME && format('"{0}"', env.SMARTER_ADMIN_USERNAME) || 'null' }},
            "SMARTER_ANTHROPIC_API_KEY": ${{ inputs.anthropic-api-key && format('"{0}"', inputs.anthropic-api-key) || 'null' }},
            "SMARTER_BRANDING_ADDRESS": ${{ env.SMARTER_BRANDING_ADDRESS && format('"{0}"', env.SMARTER_BRANDING_ADDRESS) || 'null' }},
            "SMARTER_BRANDING_CONTACT_URL": ${{ env.SMARTER_BRANDING_CONTACT_URL && format('"{0}"', env.SMARTER_BRANDING_CONTACT_URL) || 'null' }},
            "SMARTER_BRANDING_CORPORATE_NAME": ${{ env.SMARTER_BRANDING_CORPORATE_NAME && format('"{0}"', env.SMARTER_BRANDING_CORPORATE_NAME) || 'null' }},
            "SMARTER_BRANDING_SUPPORT_EMAIL": ${{ env.SMARTER_BRANDING_SUPPORT_EMAIL && format('"{0}"', env.SMARTER_BRANDING_SUPPORT_EMAIL) || 'null' }},
            "SMARTER_BRANDING_SUPPORT_HOURS": ${{ env.SMARTER_BRANDING_SUPPORT_HOURS && format('"{0}"', env.SMARTER_BRANDING_SUPPORT_HOURS) || 'null' }},
            "SMARTER_BRANDING_SUPPORT_PHONE_NUMBER": ${{ env.SMARTER_BRANDING_SUPPORT_PHONE_NUMBER && format('"{0}"', env.SMARTER_BRANDING_SUPPORT_PHONE_NUMBER) || 'null' }},
            "SMARTER_COHERE_API_KEY": ${{ inputs.cohere-api-key && format('"{0}"', inputs.cohere-api-key) || 'null' }},
            "SMARTER_DOCKER_IMAGE": ${{ env.SMARTER_DOCKER_IMAGE && format('"{0}"', env.SMARTER_DOCKER_IMAGE) || 'null' }},
            "SMARTER_EMAIL_ADMIN": ${{ env.SMARTER_EMAIL_ADMIN && format('"{0}"', env.SMARTER_EMAIL_ADMIN) || 'null' }},
            "SMARTER_FERNET_ENCRYPTION_KEY": $(jq -Rn --arg v "${{ inputs.fernet-encryption-key }}" '$v'),
            "SMARTER_FIREWORKS_API_KEY": ${{ inputs.fireworks-api-key && format('"{0}"', inputs.fireworks-api-key) || 'null' }},
            "SMARTER_GEMINI_API_KEY": ${{ inputs.gemini-api-key && format('"{0}"', inputs.gemini-api-key) || 'null' }},
            "SMARTER_GOOGLE_MAPS_API_KEY": ${{ inputs.google-maps-api-key && format('"{0}"', inputs.google-maps-api-key) || 'null' }},
            "SMARTER_GOOGLE_SERVICE_ACCOUNT_B64": ${{ inputs.google-service-account-b64 && format('"{0}"', inputs.google-service-account-b64) || 'null' }},
            "SMARTER_LLAMA_API_KEY": ${{ inputs.llama-api-key && format('"{0}"', inputs.llama-api-key) || 'null' }},
            "SMARTER_LOGIN_URL": ${{ env.SMARTER_LOGIN_URL && format('"{0}"', env.SMARTER_LOGIN_URL) || 'null' }},
            "SMARTER_LOGO": ${{ inputs.smarter-logo && format('"{0}"', inputs.smarter-logo) || 'null' }},
            "SMARTER_MAILCHIMP_API_KEY": ${{ inputs.mailchimp-api-key && format('"{0}"', inputs.mailchimp-api-key) || 'null' }},
            "SMARTER_MAILCHIMP_LIST_ID": ${{ inputs.mailchimp-list-id && format('"{0}"', inputs.mailchimp-list-id) || 'null' }},
            "SMARTER_MARKETING_SITE_URL": "https://smarter.sh",
            "SMARTER_MISTRAL_API_KEY": ${{ inputs.mistral-api-key && format('"{0}"', inputs.mistral-api-key) || 'null' }},
            "SMARTER_MYSQL_DATABASE": ${{ env.SMARTER_MYSQL_DATABASE && format('"{0}"', env.SMARTER_MYSQL_DATABASE) || 'null' }},
            "SMARTER_MYSQL_HOST": ${{ env.MYSQL_HOST && format('"{0}"', env.MYSQL_HOST) || 'null' }},
            "SMARTER_MYSQL_PASSWORD": ${{ env.SMARTER_MYSQL_PASSWORD && format('"{0}"', env.SMARTER_MYSQL_PASSWORD) || 'null' }},
            "SMARTER_MYSQL_PORT": ${{ env.MYSQL_PORT && format('"{0}"', env.MYSQL_PORT) || 'null' }},
            "SMARTER_MYSQL_ROOT_PASSWORD": ${{ env.MYSQL_ROOT_PASSWORD && format('"{0}"', env.MYSQL_ROOT_PASSWORD) || 'null' }},
            "SMARTER_MYSQL_ROOT_USERNAME": ${{ env.MYSQL_ROOT_USERNAME && format('"{0}"', env.MYSQL_ROOT_USERNAME) || 'null' }},
            "SMARTER_MYSQL_TEST_DATABASE_PASSWORD": ${{ inputs.smarter-mysql-test_database_password && format('"{0}"', inputs.smarter-mysql-test_database_password) || 'null' }},
            "SMARTER_MYSQL_TEST_DATABASE_SECRET_NAME": "smarter_test_db",
            "SMARTER_MYSQL_USER": ${{ env.SMARTER_MYSQL_USERNAME && format('"{0}"', env.SMARTER_MYSQL_USERNAME) || 'null' }},
            "SMARTER_OPENAI_API_KEY": ${{ inputs.openai-api-key && format('"{0}"', inputs.openai-api-key) || 'null' }},
            "SMARTER_PLATFORM_SUBDOMAIN": ${{ inputs.platform-subdomain && format('"{0}"', inputs.platform-subdomain) || 'null' }},
            "SMARTER_PINECONE_API_KEY": ${{ inputs.pinecone-api-key && format('"{0}"', inputs.pinecone-api-key) || 'null' }},
            "SMARTER_PINECONE_ENVIRONMENT": ${{ inputs.pinecone-environment && format('"{0}"', inputs.pinecone-environment) || 'null' }},
            "SMARTER_ROOT_DOMAIN": ${{ inputs.root-domain && format('"{0}"', inputs.root-domain) || 'null' }},
            "SMARTER_SMTP_FROM_EMAIL": "no-reply@platform.smarter.sh",
            "SMARTER_SMTP_PASSWORD": ${{ env.SMTP_PASSWORD && format('"{0}"', env.SMTP_PASSWORD) || 'null' }},
            "SMARTER_SMTP_SENDER": "no-reply@smarter.sh",
            "SMARTER_SMTP_USERNAME": ${{ env.SMTP_USERNAME && format('"{0}"', env.SMTP_USERNAME) || 'null' }},
            "SMARTER_SOCIAL_AUTH_GITHUB_KEY": ${{ inputs.social-auth-github-key && format('"{0}"', inputs.social-auth-github-key) || 'null' }},
            "SMARTER_SOCIAL_AUTH_GITHUB_SECRET": ${{ inputs.social-auth-github-secret && format('"{0}"', inputs.social-auth-github-secret) || 'null' }},
            "SMARTER_SOCIAL_AUTH_GOOGLE_OAUTH2_KEY": ${{ inputs.social-auth-google-oauth2-key && format('"{0}"', inputs.social-auth-google-oauth2-key) || 'null' }},
            "SMARTER_SOCIAL_AUTH_GOOGLE_OAUTH2_SECRET": ${{ inputs.social-auth-google-oauth2-secret && format('"{0}"', inputs.social-auth-google-oauth2-secret) || 'null' }},
            "SMARTER_SOCIAL_AUTH_LINKEDIN_OAUTH2_KEY": ${{ inputs.social-auth-linkedin-oauth2-key && format('"{0}"', inputs.social-auth-linkedin-oauth2-key) || 'null' }},
            "SMARTER_SOCIAL_AUTH_LINKEDIN_OAUTH2_SECRET": ${{ inputs.social-auth-linkedin-oauth2-secret && format('"{0}"', inputs.social-auth-linkedin-oauth2-secret) || 'null' }},
            "SMARTER_TOGETHERAI_API_KEY": ${{ inputs.togetherai-api-key && format('"{0}"', inputs.togetherai-api-key) || 'null' }},
            "SMTP_HOST": ${{ env.SMTP_HOST && format('"{0}"', env.SMTP_HOST) || 'null' }},
            "SMTP_PORT": ${{ env.SMTP_PORT && format('"{0}"', env.SMTP_PORT) || 'null' }},
            "SMTP_USE_SSL": ${{ env.SMTP_USE_SSL && format('"{0}"', env.SMTP_USE_SSL) || 'null' }},
            "SMTP_USE_TLS": ${{ env.SMTP_USE_TLS && format('"{0}"', env.SMTP_USE_TLS) || 'null' }}
          }
        }
        EOF

    - name: Convert to yaml
      id: convert-to-yaml
      shell: bash
      run: |-
        cat /tmp/values.json | jq . > /tmp/values_clean.json && mv /tmp/values_clean.json /tmp/values.json
        cat /tmp/values.json | yq eval -P --input-format=json > /tmp/values.yaml
        echo "values.yaml"
        echo "--------------------------------------------------------------------------------"
        cat /tmp/values.yaml

    # see: https://github.com/helm/helm
    #      we're installing directly from the github repo amd64 binary
    - name: Install Helm
      id: helm-install
      shell: bash
      run: |-
        curl -LO https://get.helm.sh/helm-v3.14.2-linux-amd64.tar.gz
        tar -zxvf helm-v3.14.2-linux-amd64.tar.gz
        sudo mv linux-amd64/helm /usr/local/bin/helm

    - name: Update Helm charts
      id: helm-update
      shell: bash
      run: |-
        cd helm/charts/smarter
        helm repo add bitnami https://charts.bitnami.com/bitnami
        helm repo add grafana https://grafana.github.io/helm-charts
        helm repo add loki https://grafana.github.io/helm-charts
        helm repo add mariadb https://charts.bitnami.com/bitnami
        helm repo add mysql https://charts.bitnami.com/bitnami
        helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
        helm repo add redis https://charts.bitnami.com/bitnami
        helm repo update
        helm dependency update
        helm dependency build

    # Deploy the application to Kubernetes using Helm
    - name: Deploy
      id: deploy
      shell: bash
      run: |-
        helm upgrade --install --force smarter ./helm/charts/smarter/ \
          --namespace ${{ env.NAMESPACE }} \
          --timeout 900s \
          --set mysql.auth.rootPassword="${{ env.MYSQL_ROOT_PASSWORD }}" \
          --set mysql.auth.rootUsername="${{ env.MYSQL_ROOT_USERNAME }}" \
          --set mysql.auth.password="${{ env.SMARTER_MYSQL_PASSWORD }}" \
          --set mysql.auth.database="${{ env.SMARTER_MYSQL_DATABASE }}" \
          --set mysql.auth.username="${{ env.SMARTER_MYSQL_USERNAME }}" \
          --set mariadb.auth.rootPassword="${{ env.MYSQL_ROOT_PASSWORD }}" \
          --set mariadb.auth.rootUsername="${{ env.MYSQL_ROOT_USERNAME }}" \
          --set mariadb.auth.password="${{ env.SMARTER_MYSQL_PASSWORD }}" \
          --set mariadb.auth.database="${{ env.SMARTER_MYSQL_DATABASE }}" \
          --set mariadb.auth.username="${{ env.SMARTER_MYSQL_USERNAME }}" \
          --values /tmp/values.yaml

    # Clean up secrets file
    - name: Clean up secrets
      if: always()
      shell: bash
      run: rm -f /tmp/values.yaml
