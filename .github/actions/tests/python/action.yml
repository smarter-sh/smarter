---
#------------------------------------------------------------------------------
# Run Python unit tests
#------------------------------------------------------------------------------
name: Test Python
branding:
  icon: "git-pull-request"
  color: "orange"
inputs:
  root-domain:
    description: "The root domain of the project"
    required: true
    type: string
  python-version:
    description: "The version of Python to use, such as 3.11.0"
    required: true
    type: string
  openai-api-key:
    description: "The OpenAI API key"
    required: true
    type: string
  pinecone-api-key:
    description: "The Pinecone API key"
    required: true
    type: string
  pinecone-environment:
    description: "The Pinecone environment"
    required: true
    type: string
  google-maps-api-key:
    description: "Google Maps API key"
    required: true
    type: string

runs:
  using: "composite"
  steps:
    - name: Checkout code
      id: checkout
      uses: actions/checkout@v4

    - name: Cache Python dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('./smarter/requirements/**/*.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip

    - name: Create .env
      shell: bash
      run: |
        touch ./.env
        echo "GOOGLE_MAPS_API_KEY=${{ env.GOOGLE_MAPS_API_KEY }}" >> ./.env
        echo "OPENAI_API_ORGANIZATION=${{ env.OPENAI_API_ORGANIZATION }}" >> ./.env
        echo "OPENAI_API_KEY=${{ env.OPENAI_API_KEY }}" >> ./.env
        echo "PINECONE_API_KEY=${{ env.PINECONE_API_KEY }}" >> ./.env
        echo "PINECONE_ENVIRONMENT=${{ env.PINECONE_ENVIRONMENT }}" >> ./.env
        echo "DEBUG_MODE=False" >> ./.env
        echo "ENVIRONMENT=local" >> ./.env
        echo "ROOT_DOMAIN=${{ inputs.root-domain }}" >> ./.env

      env:
        OPENAI_API_KEY: ${{ inputs.openai-api-key }}
        PINECONE_API_KEY: ${{ inputs.pinecone-api-key }}
        PINECONE_ENVIRONMENT: ${{ inputs.pinecone-environment }}
        GOOGLE_MAPS_API_KEY: ${{ inputs.google-maps-api-key }}

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Docker Compose up
      shell: bash
      run: |
        docker-compose up -d
        docker ps

    - name: Run Python unit tests
      shell: bash
      env:
        GITHUB_ACTIONS: "true"
        DEBUG_MODE: "true"
      run: |
        make docker-test
